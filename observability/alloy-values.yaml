# Grafana Alloy configuration for Windows nodes
# Helm chart: grafana/alloy
# Install: helm upgrade --install alloy grafana/alloy -n observability -f alloy-values.yaml
#
# Alloy is the successor to Grafana Agent and Promtail, with native Windows support

image:
  # Windows Server 2022 LTSC image for AKS Windows nodes
  registry: docker.io
  repository: grafana/alloy
  tag: "windowsservercore-ltsc2022"
  pullPolicy: IfNotPresent

# Disable config reloader - no Windows image available
configReloader:
  enabled: false

# DaemonSet mode for log collection with Windows node scheduling
controller:
  type: daemonset

  # Windows node selector - critical for Windows log collection
  nodeSelector:
    kubernetes.io/os: windows

  tolerations:
    - key: "os"
      operator: "Equal"
      value: "windows"
      effect: "NoSchedule"

  # Windows containers run as ContainerAdministrator
  podSecurityContext: {}

  # Extra volumes for Windows paths
  volumes:
    extra:
      - name: varlog
        hostPath:
          path: "C:/var/log"
          type: DirectoryOrCreate
      - name: programdata
        hostPath:
          path: "C:/ProgramData/containerd/root/io.containerd.grpc.v1.cri/containers"
          type: DirectoryOrCreate

# Alloy configuration
alloy:
  # Windows-specific storage path
  storagePath: "C:/ProgramData/GrafanaLabs/Alloy/data"

  # Extra args for Windows
  extraArgs:
    - "--server.http.listen-addr=0.0.0.0:12345"

  securityContext: {}

  # Volume mounts
  mounts:
    varlog: false
    dockercontainers: false
    extra:
      - name: varlog
        mountPath: "C:/var/log"
      - name: programdata
        mountPath: "C:/ProgramData/containerd/root/io.containerd.grpc.v1.cri/containers"
        readOnly: true

  # Alloy River configuration
  configMap:
    create: true
    content: |
      // =============================================================================
      // Grafana Alloy Configuration for Windows Nodes
      // Collects logs and sends to Loki with same label format as Fluent-bit
      // =============================================================================

      // Logging configuration
      logging {
        level  = "info"
        format = "logfmt"
      }

      // Discovery for Kubernetes pods on this node
      discovery.kubernetes "pods" {
        role = "pod"

        selectors {
          role = "pod"
          field = "spec.nodeName=" + env("HOSTNAME")
        }
      }

      // Relabeling for pod metadata - match Fluent-bit label format
      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        // Extract namespace
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        // Extract pod name
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        // Extract container name
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }

        // Extract node name
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }

        // Build log file path for Windows containers (containerd path)
        rule {
          source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
          target_label  = "__path__"
          separator     = "/"
          replacement   = "C:/var/log/pods/*$1/$2/*.log"
        }
      }

      // Loki log source for Windows container logs
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.add_labels.receiver]
      }

      // Process and add labels to match Fluent-bit format
      loki.process "add_labels" {
        forward_to = [loki.write.loki.receiver]

        // Add static labels matching Fluent-bit output
        stage.static_labels {
          values = {
            job         = "alloy",
            cluster     = "demodeck-aks",
            environment = "demo",
            os          = "windows",
            collector   = "alloy",
          }
        }

        // Parse JSON logs if present
        stage.json {
          expressions = {
            log    = "log",
            stream = "stream",
            time   = "time",
          }
        }
      }

      // Write to Loki (which stores in Azure Blob Storage)
      loki.write "loki" {
        endpoint {
          url = "http://loki-gateway.observability.svc.cluster.local:80/loki/api/v1/push"

          // Batch settings for better performance
          batch_wait = "1s"
          batch_size = "1MiB"
        }
      }

resources:
  limits:
    cpu: 200m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

serviceAccount:
  create: true
  name: alloy

# Enable RBAC
rbac:
  create: true
